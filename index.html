<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- FOUC & Anti-Dup -->
    <style>
        .upload-section {
            display: none !important
        }
    </style>
    <script>(function () { const n = Date.now(), l = localStorage.getItem("ts"); if (l && (n - l < 2000)) { document.write("<div style=\"display:flex;justify-content:center;align-items:center;height:100vh;\">⚠️ Duplicate...</div>"); window.stop(); setTimeout(() => window.close(), 100); throw "Dup"; } localStorage.setItem("ts", n); const bc = new BroadcastChannel("lock"); bc.postMessage("chk"); bc.onmessage = e => { if (e.data === "ali") { document.write("⚠️ Already running"); window.stop(); self.close(); } if (e.data === "chk") bc.postMessage("ali"); }; })();</script>
    <title>NotebookLM 互动闪卡 - 极致沉浸版</title>

    <!-- MathJax 配置 -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            },
            options: {
                enableMenu: false
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js"></script>

    <!-- MediaPipe AI 库 -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Outfit:wght@300;400;600;800&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="css/style.css?v=10">
</head>

<body>
    <video id="input_video" playsinline autoplay muted></video>

    <div id="gesture-feedback"></div>
    <div id="toast" class="toast">这是一个提示消息</div>

    <div id="calibration-modal" class="modal-overlay" style="z-index: 4000;">
        <div class="modal-content">
            <div class="modal-title">✌️ 手势校准</div>
            <p style="color:#7F8C8D; font-size:14px; margin-bottom:20px;">请对着摄像头做出 <strong>OK手势</strong><br>保持稳定即可自动录入。
            </p>
            <div class="calibration-video-container">
                <canvas id="calibration-canvas" width="640" height="480"></canvas>
                <div class="calibration-status" id="cal-status">寻找手部...</div>
            </div>
            <button class="modal-btn" id="cancel-calib-btn"
                style="background: white; border:2px solid #eee; color: #7F8C8D; box-shadow: 0 4px 0 #eee;">取消</button>
        </div>
    </div>

    <div id="rendering-modal" class="modal-overlay" style="z-index: 3000;">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px; color: #2ECC71;" id="modal-title">准备学习环境...</h3>
            <p style="margin-bottom: 20px; color: #7F8C8D;">正在优化数学公式与渲染资源</p>
            <div
                style="width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-bottom: 10px;">
                <div id="render-bar" style="width: 0%; height: 100%; background: #2ECC71; transition: width 0.3s;">
                </div>
            </div>
            <div id="render-text" style="font-size: 12px; color: #999; font-family: monospace;">0%</div>
        </div>
    </div>

    <div id="flow-start-screen">
        <div class="breathing-circle"></div>
        <div class="flow-title" style="font-size: 28px; font-weight: 300; margin-bottom: 15px;">准备进入心流</div>
        <div class="flow-subtitle"
            style="font-size: 15px; color: #999; margin-bottom: 30px; font-weight: 300; max-width: 300px; line-height: 1.6;">
            深呼吸，排除杂念。<br>让思绪慢下来，专注于当下的每一个知识点。</div>

        <button id="fullscreen-hint-btn" class="secondary-btn"
            style="position: fixed; top: 12%; left: 50%; transform: translateX(-50%); z-index: 9999; font-size: 14px; padding: 10px 24px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.3); color: #fff; border-radius: 30px; cursor: pointer; backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: opacity 1s ease;">
            📺 点击全屏进入沉浸模式 (F11)
        </button>
        <button class="start-flow-btn">开始专注</button>
    </div>

    <div id="celebration-overlay">
        <div class="celebration-content">
            <div style="font-size: 80px; margin-bottom: 20px;">🎉</div>
            <h2 style="font-size: 32px; color: #2C3E50; margin-bottom: 10px; font-family: 'Comic Sans MS';">Great Job!
            </h2>
            <p style="color: #7F8C8D; margin-bottom: 30px; font-size: 18px;">你已完成当前所有内容的学习。</p>
            <button class="action-btn primary"
                style="width: auto; padding: 15px 50px; font-size: 18px; margin: 0 auto;">Replay Again</button>
        </div>
    </div>

    <div id="play-settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">心流节奏设置</div>
            <div class="settings-group">
                <span class="settings-label">模式</span>
                <div class="settings-options">
                    <div class="settings-option selected">仅看题目</div>
                    <div class="settings-option">题目+答案</div>
                </div>
            </div>
            <div class="settings-group">
                <span class="settings-label">正面停留时间 (看题)</span>
                <div class="range-container">
                    <input type="range" min="1" max="20" value="3" class="range-slider" id="interval-slider">
                    <span class="range-value" id="interval-display"
                        style="color: #2ECC71; font-weight:bold; width: 40px;">3s</span>
                </div>
            </div>
            <div class="settings-group" id="answer-time-group">
                <span class="settings-label">背面停留时间 (看答案)</span>
                <div class="range-container">
                    <input type="range" min="1" max="20" value="3" class="range-slider" id="answer-interval-slider">
                    <span class="range-value" id="answer-interval-display"
                        style="color: #2ECC71; font-weight:bold; width: 40px;">3s</span>
                </div>
            </div>
            <div class="settings-group"
                style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 8px 12px; background: #F8F9FA; border-radius: 12px;">
                <span class="settings-label" style="margin-bottom: 0; color: #555;">自动跳过已掌握</span>
                <label class="switch">
                    <input type="checkbox" id="skip-mastered-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="settings-group"
                style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 8px 12px; background: #F8F9FA; border-radius: 12px;">
                <span class="settings-label" style="margin-bottom: 0; color: #555;">掌握后自动跳转</span>
                <label class="switch">
                    <input type="checkbox" id="auto-next-toggle" checked>
                    <span class="slider round"></span>
                </label>
            </div>
            <button class="modal-btn">保存设置</button>
        </div>
    </div>

    <div class="modal-overlay" id="help-modal">
        <div class="modal-content" style="max-width: 450px; text-align: left;">
            <div class="modal-title" style="text-align: center; margin-bottom: 25px;">使用指南</div>

            <div style="margin-bottom: 25px;">
                <h4 style="color: #2C3E50; margin-bottom: 12px; display:flex; align-items:center; gap:6px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                        <circle cx="12" cy="13" r="4" />
                    </svg>
                    手势控制
                </h4>
                <div
                    style="text-align:center; background:#FDF6E3; padding:15px; border-radius:12px; border:2px solid #eee; display: flex; justify-content: space-around;">
                    <div style="text-align: center;">
                        <div style="font-size:32px; margin-bottom:8px;">👌</div>
                        <div style="font-size:12px; font-weight:bold; color:#2ECC71;">单手 OK</div>
                        <div style="font-size:10px; color:#7F8C8D;">标记已掌握</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size:32px; margin-bottom:8px;">👐</div>
                        <div style="font-size:12px; font-weight:bold; color:#3498DB;">双手摊开</div>
                        <div style="font-size:10px; color:#7F8C8D;">不会/下一个</div>
                    </div>
                </div>
            </div>




            <div style="margin-bottom: 25px;">
                <h4 style="color: #2C3E50; margin-bottom: 10px; display:flex; align-items:center; gap:6px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M12 8v8" />
                    </svg>
                    极致沉浸模式
                </h4>
                <ul style="color: #7F8C8D; font-size: 13px; line-height: 1.8; list-style: none; padding-left: 5px;">
                    <li>🤫 <strong>自动隐藏</strong>：鼠标静止 3 秒后，除了卡片外所有内容都会消失。</li>
                    <li>🖱️ <strong>隐藏光标</strong>：沉浸时鼠标指针也会隐藏，杜绝干扰。</li>
                    <li>👋 <strong>唤醒</strong>：移动鼠标或点击屏幕即可恢复界面。</li>
                </ul>
            </div>

            <button class="modal-btn"
                style="margin-top: 15px; background: #2ECC71; box-shadow: 0 6px 0 #27AE60;">开始学习</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <button id="camera-btn" class="top-btn" title="开启手势控制" style="display: none;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                    <circle cx="12" cy="13" r="4" />
                </svg>
            </button>
            <button id="play-btn" class="top-btn" title="播放/暂停" style="display: none;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="5 3 19 12 5 21 5 3" />
                </svg>
            </button>
            <button id="settings-btn" class="top-btn" title="播放设置" style="display: none;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
            </button>
            <button id="help-btn" class="top-btn" title="查看帮助">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                    <path d="M12 17h.01" />
                </svg>
            </button>
            <button id="sound-btn" class="top-btn active" title="开启/关闭音效">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" />
                </svg>
            </button>
        </div>

        <div class="upload-section" id="upload-box">
            <h3 style="margin-bottom:15px; font-weight:800; color:#2C3E50; font-size:24px;">导入题库</h3>
            <p style="color:#7F8C8D; font-size:16px;">请上传 CSV 文件 (格式: 问题,答案)</p>
            <input type="file" id="file-input" accept=".csv">
            <label for="file-input" class="upload-btn">选择 CSV 文件</label>
        </div>

        <div class="card-section" id="app-box">
            <div class="card-container">
                <div class="card" id="flashcard">
                    <div class="card-face card-front">
                        <span class="card-label">Question</span>
                        <div class="card-content" id="q-text"></div>
                        <div class="card-hint">Click to flip</div>
                    </div>
                    <div class="card-face card-back">
                        <span class="card-label">Answer</span>
                        <div class="card-content" id="a-text"></div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <div class="nav-bar">
                    <button class="nav-btn" id="prev-btn" title="上一个 (双击跳转未掌握)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                    </button>
                    <div class="progress-text">
                        <span id="progress-str">1 / 10</span>
                        <span class="progress-sub">已掌握: 0</span>
                    </div>
                    <button class="nav-btn" id="next-btn" title="下一个 (双击跳转未掌握)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m9 18 6-6-6-6" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="controls">
                <button class="action-btn" id="mode-btn" title="切换顺序/乱序">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-12.6" />
                        <path d="m21.5 10.3.6-6.6-6.6.6" />
                        <path d="M2 6h1.4c1.3 0 2.5.6 3.3 1.7l1.7 1.9" />
                        <path d="m21.5 13.7.6 6.6-6.6-.6" />
                        <path d="M12.7 14.3l8.2 7.3" />
                        <path d="M22 6l-6.6.6" />
                    </svg>
                    <span>乱序</span>
                </button>

                <button class="action-btn" id="mark-btn" title="标记为已掌握 (Enter)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                    </svg>
                    <span>掌握</span>
                </button>
            </div>
        </div>
    </div>

    <script type="module" src="js/app.js?v=10"></script>
</body>

</html>